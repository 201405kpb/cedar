<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//vega.github.io/vega/vega.js"></script>

<script src="//vega.github.io/vega-lite/vega-lite.js"></script>
<script src="//vega.github.io/vega-editor/vendor/vega-embed.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/then-request/2.2.0/request.js"></script>
<script type="text/javascript" src="../../src/cedar.js"></script>


<div id="chart"></div>
<div id="vis"></div>


<script>
var chart = new Cedar({"type": "bar"});

var dataset = {
  "url":"http://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Education_WebMercator/MapServer/5",
  "query": {
    "groupByFieldsForStatistics": "FACUSE",
    "outStatistics": [{
      "statisticType": "sum",
      "onStatisticField": "TOTAL_STUD",
      "outStatisticFieldName": "TOTAL_STUD_SUM"
    }]
  },
  "mappings":{
    "sort": "TOTAL_STUD_SUM DESC",
    "x": {"field":"FACUSE","label":"Facility Use"},
    "y": {"field":"TOTAL_STUD_SUM","label":"Total Students"}
  }
};

chart.tooltip = {
  "title": "{FACUSE}",
  "content": "{TOTAL_STUD_SUM} Students in {FACUSE}"
}

chart.dataset = dataset;


chart.show({
  elementId: "#chart",
  autolabels: true,
  renderer: "svg"
});


request('GET', 'http://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Cultural_and_Society_WebMercator/MapServer/51/query?where=ART_TYPE%20%3D%20%27Mural%27&returnGeometry=false&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&outFields=*&f=json&groupByFieldsForStatistics=MEDIUM&outStatistics=%5B%7B%22statisticType%22%3A%22count%22%2C%22onStatisticField%22%3A%22OBJECTID%22%2C%22outStatisticFieldName%22%3A%22count_SUM%22%7D%5D&orderByFields=count_SUM%20DESC')
  .done(function(res) {
    var response = JSON.parse(res.getBody());
    console.log(response);
    var data = response.features.map(function(attr) { return attr.attributes; });
    console.log(data);
    var vlSpec = {
    "data": {
      "values": data
    },
    "mark": "bar",
    "encoding": {
      "x": {"field": "MEDIUM", "type": "nominal"},
      "y": {
        "field": "count_SUM", "type": "quantitative",
        "axis": {
          "title": "Average of b"
        }
      }
    }
  };

  var embedSpec = {
    mode: "vega-lite",  // Instruct Vega-Embed to use the Vega-Lite compiler
    spec: vlSpec,
    actions: {
      export: false,
      source: false,
      editor: false
    }
  };

  // Embed the visualization in the container with id `vis`
  vg.embed("#vis", embedSpec, function(error, result) {
    // Callback receiving the View instance and parsed Vega spec
    // result.view is the View, which resides under the '#vis' element
    console.log(result);
  });
});

</script>
